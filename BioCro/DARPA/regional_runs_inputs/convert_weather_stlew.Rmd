---
title: "Convert Regional Runs Weather Data from NC to BioCro csv"
author: "Author: Kristina Riemer"
output: github_document
urlcolor: blue
---

## Read in libraries

```{r}
library(ncdf4)
library(PEcAn.all)
library(PEcAn.BIOCRO)
library(dplyr)
```

## Get weather data

This subset is in the Pecan standard format, which is a netCDF file. The dimensions are latitude x longitude x time (8 x 120 x 8,764). These time steps are every three hours from 2008 through 2010. There are 10 weather variables, including temperature, precipitation flux, and solar radiation. 

This weather data file, `stlew.nc`, is automatically downloaded from the Cyverse Discovery Environment. It can also be generated by following instructions in [`regional_runs_inputs/subset_weather.Rmd`](https://github.com/az-digitalag/model-vignettes/blob/master/BioCro/DARPA/regional_runs_inputs/subset_weather.Rmd). 

```{r}
metfile <- "weather_subsets/stlew.nc"
if (!file.exists(metfile)) {
  download.file("https://de.cyverse.org/dl/d/E45B235A-580F-4E1E-9496-9A7C2ED95B0E/stlew.nc", metfile)
}
met_stlew <- nc_open(metfile)
```

## Convert and save weather data

The weather dataset has to be converted from netCDF file format to the format required for BioCro. Data for each of the locations (unique latitude and longitude combinations) is turned into a flat csv file, with one row per hour for the years 2008-2010.  

```{r}
# Get all locations
lat <- ncvar_get(met_stlew, "latitude")
lon <- ncvar_get(met_stlew, "longitude")
latlon <- expand.grid(lat = lat, lon = lon)

# Get met conversion inputs that apply across all locations
time_vec <- ncvar_get(met_stlew, "time")
time_origin1 <- ncatt_get(met_stlew, "time", "units")
time_origin2 <- gsub( ".*(\\d{4}-\\d{2}-\\d{2}).*", "\\1", time_origin1$value)
start_date <- as.Date(time_origin2) + time_vec[1]
end_date <- as.Date(time_origin2) + time_vec[length(time_vec)] - 1

# Convert met from Pecan to BioCro format for all locations
if (!file.exists("biocro_met_stlew/biocro_met_stlew.csv")) {
  dir.create("biocro_met_stlew/")
  biocro_met_locations <- c()
  for(point in 1:nrow(latlon)){
    met <- load.cfmet(met_stlew, lat = latlon$lat[point], 
                      lon = latlon$lon[point], start.date = start_date, 
                      end.date = end_date)
    #met_sub <- met[(met$year %in% 2000:2010),] 
    met_hourly <- cfmet.downscale.time(met, output.dt = 1)
    biocro_met <- cf2biocro(met_hourly)
    biocro_met <- biocro_met %>%
      mutate(RH = case_when(RH >= 1 ~ 0.99999999999999,
                            RH < 1 ~ RH))
    biocro_met_location <- biocro_met %>% 
      mutate(latitude = latlon$lat[point], 
             longitude = latlon$lon[point])
    biocro_met_locations <- rbind(biocro_met_locations, biocro_met_location)
    biocro_met_path <- paste0("biocro_met_stlew/stlew-", 
                              latlon$lat[point], "-", latlon$lon[point], 
                              ".2010.csv")
    write.csv(biocro_met, biocro_met_path, row.names = FALSE)
  }
  write.csv(biocro_met_locations, "biocro_met_stlew/biocro_met_stlew.csv", 
            row.names = FALSE)
}
all_met <- read.csv("biocro_met_stlew/biocro_met_stlew.csv")
```

## Plots of weather data

These are various plots to explore what is available in the weather data and the data itself. First modified date and year columns are added. 

```{r}
all_met_plot <- all_met %>% 
  filter(year == 2008) %>% 
  tidyr::unite(latitudelongitude, latitude:longitude) %>% 
  mutate(date = as.Date(paste0(year, "-01-01")) - 1 + doy, 
         time = case_when(
           hour < 10 ~ paste0("0", hour, ":00"), 
           hour >= 10 ~ paste0(hour, ":00")
         ), 
         datetime_gmt = as.POSIXct(paste(date, time), tz = "GMT"), 
         datetime = as.POSIXct(format(datetime_gmt, tz = "America/Chicago")), 
         date = as.Date(datetime, tz = "America/Chicago"), 
         year_plot = format(date, "%Y"), 
         latitudelongitude = as.factor(latitudelongitude)) 
```

Plot of one year of hourly weather variables. 

```{r}
all_met_plot_year <- all_met_plot %>% 
  filter(year_plot == 2008 & latitudelongitude == "39.125_-101.375") %>%
  select(datetime, latitudelongitude, solar:precip) %>% 
  tidyr::gather(weather_var, weather_value, solar:precip)
  
ggplot(all_met_plot_year, aes(x = datetime, y = weather_value, color = latitudelongitude)) +
  geom_line() +
  facet_wrap(~weather_var, scales = "free_y")
```

Plot of one day of hourly weather variables. 

```{r}
all_met_plot_day <- all_met_plot %>% 
  filter(date == as.Date("2008-01-01")) %>% 
  select(datetime, latitudelongitude, solar:precip) %>% 
  tidyr::gather(weather_var, weather_value, solar:precip)

ggplot(all_met_plot_day, aes(x = datetime, y = weather_value, color = latitudelongitude)) +
  geom_line() +
  facet_wrap(~weather_var, scales = "free_y") +
  theme(legend.position = "none")
```

Spatial plot of weather data location for temperature in 2020 at noon during May. 

```{r}
overall_map <- map_data("world") %>% 
  filter(region == "USA" & is.na(subregion))

spatial_met_plot <- all_met %>% 
  filter(year == 2010, doy == 150, hour == 12)

ggplot() +
  geom_polygon(data = overall_map, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = spatial_met_plot, aes(x = longitude, y = latitude, fill = Temp)) +
  coord_quickmap()
```

## Subset ecoregions

Subset ecoregions data appropriate for this weather data subset. 

```{r}
# ecoregions_df <- read.csv("ecoregions/ecoregions.csv")
# ecoregions_df_chiruss <- ecoregions_df %>% 
#    filter(lat > 20 & lat < 80,
#           long > 60 & long < 130)
# write.csv(ecoregions_df_chiruss, "ecoregions/eocregions_chiruss.csv")
```
